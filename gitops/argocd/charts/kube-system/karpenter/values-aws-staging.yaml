# SPDX-FileCopyrightText: Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
# SPDX-License-Identifier: Apache-2.0

---
karpenter:
  serviceAccount:
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::447241706233:role/karpenter

  controller:
    resources:
      limits:
        # cpu: 1
        memory: 1Gi
      requests:
        cpu: 500m
        memory: 256Mi
  webhook:
    resources:
      limits:
        # cpu: 100m
        memory: 50Mi
      requests:
        cpu: 200m
        memory: 150Mi
  clusterName: portefaix-staging-eks
  aws:
    defaultInstanceProfile: KarpenterNodeInstanceProfile-portefaix-staging-eks
    interruptionQueueName: portefaix-staging-eks

nodepools:
- name: networking
  labels:
    service: networking
  requirements:
    arch: ["amd64", "arm64"]
    os: ["linux"]
    capacityType: ["on-demand"]
    additionnals:
    - key: karpenter.k8s.aws/instance-family
      operator: In
      values: ["c6a", "c6i", "m6a", "m6i", "c7a", "c7g", "c7i", "m7a", "m7g", "m7i", "c8g", "m8g"]
    - key: karpenter.k8s.aws/instance-size
      operator: In
      values: ["large", "xlarge", "2xlarge", "4xlarge"]
    # zones: ["eu-west-1a", "eu-west-1b", "eu-west-1c"]
  cilium:
    enabled: true
  taints:
    - key: "role"
      value: "networking"
      effect: "NoSchedule"
  nodeClass: "karpenter-default"
  limits:
    cpu: "20"
    memory: "64Gi"
  disruption:
    budgets:
    # Prod:
    # - nodes: 10%
    #   duration: 1h
    #   replacements: 5        # max 5 remplacements every 10 minutes
    #   rate: "1/m"
    # Non Prod:
    # - nodes: 30%
    #   duration: 10m
    #   replacements: 5        # Jusqu'Ã  5 remplacements toutes les 10 minutes
    #   rate: "1/m"
    # Main day window (6am-2am next day): Blocks Underutilized nodes
    # This is the most restrictive budget for Underutilized during working hours
    - duration: 20h
      nodes: "0"
      reasons:
      - Underutilized
      schedule: 0 6 * * *
    # Main day window (6am-2am next day): Allows Empty and Drifted nodes
    - duration: 20h
      nodes: 10%
      reasons:
      - Empty
      - Drifted
      schedule: 0 6 * * *
    # Maintenance window (2am-6am): Allows all types of disruption
    # This is a maintenance window where we allow more aggressive optimization
    # Including scaling down underutilized nodes
    - duration: 4h
      nodes: 10%
      reasons:
      - Underutilized
      - Empty
      - Drifted
      schedule: 0 2 * * *

aws:
  enabled: true
  ec2NodeClass:
  - name: xxxx
    role: xxx
    ebs:
      volumeSize: 100Gi
      volumeType: gp3
      encrypted: true

azure:
  enabled: true
  machineClasses: []
  # - name: observability
  #   subscriptionId: "xxxx-xxxx-xxxx"
  #   resourceGroup: "my-aks-rg"
  #   vmSize: "Standard_D4s_v3"
  #   subnetId: "/subscriptions/.../subnets/my-subnet"
  #   securityGroupId: "/subscriptions/.../nsg/my-nsg"
  #   image:
  #     publisher: "Canonical"
  #     offer: "UbuntuServer"
  #     sku: "18.04-LTS"
  #     version: "latest"
  #   osDisk:
  #     sizeGB: 64
  #     type: "Premium_LRS"
