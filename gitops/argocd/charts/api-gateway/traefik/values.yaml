# Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

---
grafana:
  # Grafana folder in which to store the dashboards
  folder: networking

ingress:
  enabled: false

traefik:
  commonLabels:
    portefaix.xyz/version: v0.46.0

  ingressClass:
    enabled: true
    isDefaultClass: false
    name: traefik

  experimental:
    kubernetesGateway:
      enabled: true

  ingressRoute:
    dashboard:
      enabled: false

  additionalArguments:
  - "--api.insecure=true"

  providers:
    # Enable cross namespace references
    kubernetesCRD:
      enabled: true
      allowCrossNamespace: true
    # Enable published service
    kubernetesIngress:
      publishedService:
        enabled: true

  logs:
    general:
      format: json
      level: INFO
    access:
      enabled: true
      format: json

  metrics:
    prometheus:
      entryPoint: metrics
      addEntryPointsLabels: true
      addRoutersLabels: true
      addServicesLabels: true
      service:
        enabled: true
        # labels:
        #   monitoring: portefaix
      serviceMonitor:
        metricRelabelings: []
        relabelings: []
        jobLabel: traefik
        interval: 30s
        honorLabels: true
        # TODO: remove when https://github.com/traefik/traefik-helm-chart/pull/948 is merged
        namespace: api-gateway
      prometheusRule:
        additionalLabels: {}
        # TODO: remove when https://github.com/traefik/traefik-helm-chart/pull/948 is merged
        namespace: api-gateway
        rules:
        - alert: TraefikTooManyRequests
          expr: avg(traefik_service_open_connections) > 50
          for: 5m
          labels:
            severity: warning
        - alert: TraefikHighHttp4xxErrorRateService
          expr: sum(rate(traefik_service_requests_total{code=~"4.*"}[3m])) by (service) / sum(rate(traefik_service_requests_total[3m])) by (service) * 100 > 5
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: Traefik high HTTP 4xx error rate service (instance {{ $labels.instance }})
            description: "Traefik service 4xx error rate is above 5%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
        - alert: TraefikHighHttp5xxErrorRateService
          expr: sum(rate(traefik_service_requests_total{code=~"5.*"}[3m])) by (service) / sum(rate(traefik_service_requests_total[3m])) by (service) * 100 > 5
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: Traefik high HTTP 5xx error rate service (instance {{ $labels.instance }})
            description: "Traefik service 5xx error rate is above 5%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"


  # tracing:
  #   openTelemetry: # traefik v3+ only
  #     grpc: {}
  #     insecure: true
  #     address: localhost:4317
